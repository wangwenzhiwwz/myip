<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>IP Insight | Monochrome</title>
<link rel="preconnect" href="https://api.ipify.org">
<link rel="preconnect" href="https://ipwho.is">
<link rel="preconnect" href="https://dns.google">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
/* --- 极致黑白视觉系统 (Monochrome) --- */
:root {
  --bg-body: #f2f3f5;
  --bg-card: #ffffff;
  --bg-inner: #f7f9fc;
  
  --text-main: #000000;
  --text-label: #666666;
  --text-value: #111111;
  --text-dim: #999999;
  
  --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
  --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
  
  --radius: 20px;
  --font-family: 'Inter', system-ui, -apple-system, sans-serif;
  
  /* 状态颜色 */
  --status-green: #10b981;
  --status-yellow: #f59e0b;
  --status-red: #ef4444;
  --status-gray: #e5e7eb;
}

html.dark-mode {
    --bg-body: #0a0a0a;
    --bg-card: #141414;
    --bg-inner: #1f1f1f;
    --text-main: #ffffff;
    --text-label: #888888;
    --text-value: #f5f5f5;
    --text-dim: #555555;
    
    --shadow-card: 0 0 0 1px rgba(255, 255, 255, 0.1);
    --shadow-hover: 0 0 0 1px rgba(255, 255, 255, 0.3);
    
    --status-gray: #333333;
}

* { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

body {
  font-family: var(--font-family);
  background-color: var(--bg-body);
  color: var(--text-main);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  padding: 40px 16px; 
  transition: background 0.3s, color 0.3s;
}

.container {
  width: 100%;
  max-width: 800px; 
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* Controls */
.controls-header {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-bottom: 4px;
  z-index: 10;
}
.btn-circle {
  width: 40px; height: 40px;
  border-radius: 50%; 
  background: var(--bg-card);
  color: var(--text-main);
  border: none;
  box-shadow: var(--shadow-card);
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700;
  font-size: 0.85rem;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}
.btn-circle:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }
.btn-circle svg { width: 18px; height: 18px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

/* --- Hero Card Fusion --- */
.hero-card {
  background: var(--bg-card);
  border-radius: var(--radius);
  box-shadow: var(--shadow-card);
  padding: 0; 
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  position: relative;
  overflow: hidden; 
  transition: box-shadow 0.3s, background 0.3s, transform 0.2s;
  min-height: 320px; 
  justify-content: center;
  /* 关键：让整个卡片可点击 */
  cursor: pointer; 
}

/* 鼠标悬停时，地图稍微清晰一点，提示可点击 */
.hero-card:hover .hero-map-bg { opacity: 0.25; }
html.dark-mode .hero-card:hover .hero-map-bg { opacity: 0.4; }

/* 背景地图层 */
.hero-map-bg {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 0;
    pointer-events: none; 
    opacity: 0; 
    transition: opacity 0.5s ease;
    filter: grayscale(100%) contrast(1.1) brightness(1.1);
}
.hero-map-bg.loaded { opacity: 0.15; }

html.dark-mode .hero-map-bg {
    filter: invert(90%) hue-rotate(180deg) grayscale(20%) contrast(1.2) brightness(0.8);
}
html.dark-mode .hero-map-bg.loaded { opacity: 0.3; }

/* 渐变遮罩层 */
.hero-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 1;
    pointer-events: none;
    background: radial-gradient(circle at center, var(--bg-card) 30%, rgba(255,255,255,0) 100%);
}
html.dark-mode .hero-overlay {
    background: radial-gradient(circle at center, var(--bg-card) 30%, rgba(0,0,0,0) 100%);
}

/* 内容层 */
.hero-content {
    position: relative;
    z-index: 2;
    padding: 48px 30px;
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    /* 关键：让内容层本身不阻挡点击，但子元素（如文字）可以交互 */
    pointer-events: none; 
}

/* 让特定的子元素恢复交互 */
.hero-content > * { pointer-events: auto; }
/* 但像 label 这种纯展示的其实不需要交互，为了防止误触复制，可以保持 auto 或者 none */

.flag-container {
  width: 88px; height: 66px;
  border-radius: 12px;
  background: var(--bg-inner); 
  margin-bottom: 20px;
  display: flex; align-items: center; justify-content: center;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
  z-index: 2;
}
.flag-img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s; }
.flag-img.loaded { opacity: 1; }

.label-sup {
  font-size: 0.75rem;
  font-weight: 800;
  letter-spacing: 0.12em;
  color: var(--text-label);
  text-transform: uppercase;
  margin-bottom: 12px;
  text-shadow: 0 2px 4px var(--bg-card); 
}

#ipAddr {
  font-size: clamp(2.5rem, 6vw, 4rem); 
  font-weight: 800;
  color: var(--text-main);
  line-height: 1;
  margin-bottom: 20px;
  letter-spacing: -0.04em;
  cursor: pointer; /* 保持点击复制 */
  transition: opacity 0.2s, color 0.3s;
  text-shadow: 0 2px 0 var(--bg-card), 0 0 20px var(--bg-card); 
}
#ipAddr:active { opacity: 0.6; }

.location-pill {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: var(--bg-inner);
  padding: 10px 24px;
  border-radius: 99px;
  font-weight: 600;
  font-size: 1rem;
  color: var(--text-value);
  transition: background 0.3s, color 0.3s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
}
.location-pill svg { width: 16px; height: 16px; fill: currentColor; }

/* --- Bento Grid --- */
.bento-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  grid-auto-flow: dense; 
}

.card {
  background: var(--bg-card);
  border-radius: 20px;
  box-shadow: var(--shadow-card);
  padding: 24px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 8px;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  cursor: pointer;
  min-height: 110px;
}
.card:hover { transform: translateY(-4px); box-shadow: var(--shadow-hover); }
.card:active { transform: scale(0.98); }

.info-row { display: flex; flex-direction: column; gap: 8px; }

.card-label {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.75rem;
  font-weight: 700;
  color: var(--text-label);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

/* Icons */
.card-icon-box {
  width: 28px; height: 28px;
  display: flex; align-items: center; justify-content: center;
  background: var(--bg-inner);
  border-radius: 8px;
  color: var(--text-main);
  transition: background 0.3s, color 0.3s;
}
.card-icon-box svg { width: 15px; height: 15px; fill: none; stroke: currentColor; stroke-width: 2; }

.card-value {
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--text-value);
  word-break: break-all;
  line-height: 1.5;
  margin-top: 4px;
  transition: color 0.2s;
}
.card-value.dim { color: var(--text-dim); font-weight: 500; }
.card-value.copied { color: var(--status-green) !important; }

/* Network Info List */
.network-list {
  display: flex; flex-direction: column; gap: 12px; margin-top: 6px;
}
.network-item {
  display: flex; flex-direction: column; gap: 2px;
}
.network-label {
  font-size: 0.7rem; font-weight: 700; color: var(--text-label); opacity: 0.8; text-transform: uppercase; letter-spacing: 0.05em;
}
.network-val {
  font-size: 0.95rem; font-weight: 600; color: var(--text-value); font-family: 'Inter', monospace;
}

/* Layout Helpers */
.span-1 { grid-column: span 1; }
.span-2 { grid-column: span 2; }
.span-4 { grid-column: span 4; }

/* Connectivity List */
.latency-list { display: flex; flex-direction: column; gap: 10px; width: 100%; margin-top: 5px; }
.latency-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; font-weight: 600; }
.latency-name { display: flex; align-items: center; gap: 8px; color: var(--text-label); }
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--status-gray); transition: background 0.3s; }
.status-dot.pulse { animation: pulse 2s infinite; }
@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
    70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
    100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
}
.latency-ms { font-family: 'Inter', monospace; color: var(--text-value); opacity: 0.9; }

/* Skeleton */
.skeleton {
  background: linear-gradient(90deg, var(--bg-inner) 25%, rgba(128,128,128,0.1) 50%, var(--bg-inner) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  color: transparent !important;
  border-radius: 6px;
  min-height: 1.2em;
}
html.dark-mode .skeleton { background: linear-gradient(90deg, #222 25%, #333 50%, #222 75%); }
@keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

@media (max-width: 768px) {
  .bento-grid { grid-template-columns: repeat(2, 1fr); }
  .span-1, .span-2, .col-full { grid-column: span 1; } 
  .span-4 { grid-column: span 2; }
}
@media (max-width: 480px) {
  .hero-card { padding: 0; min-height: 280px; }
  .hero-content { padding: 40px 20px; }
  .bento-grid { grid-template-columns: 1fr; }
  .span-1, .span-2, .col-full, .span-4 { grid-column: span 1; }
}
</style>
</head>
<body>

<div class="container">
  <div class="controls-header">
    <button id="langToggle" class="btn-circle" title="Switch Language">EN</button>
    <button id="themeToggle" class="btn-circle" title="Toggle Theme">
        <svg viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
    </button>
    <button id="refreshBtn" class="btn-circle" title="Refresh">
        <svg viewBox="0 0 24 24"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
    </button>
  </div>

  <div class="hero-card" id="heroCard">
    <iframe id="heroMapFrame" class="hero-map-bg" src="about:blank" loading="lazy"></iframe>
    <div class="hero-overlay"></div>
    
    <div class="hero-content">
        <div class="flag-container">
          <div id="flagSkeleton" class="skeleton" style="width:100%; height:100%"></div>
          <img id="ip-flag" class="flag-img" alt="Flag">
        </div>
        <div class="label-sup" data-zh="公网 IP 地址" data-en="Public IP Address">Public IP Address</div>
        <div id="ipAddr" class="skeleton" onclick="copyText(this); event.stopPropagation();" style="min-width: 200px; height: 3.5rem;"></div>
        <div class="location-pill">
          <svg viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
          <div id="ipPlace" class="skeleton" style="min-width: 100px; height: 1.2em;"></div>
        </div>
    </div>
    </div>

  <div class="bento-grid">

    <div class="card span-2" id="card_ipv6" onclick="copyText(document.getElementById('ipv6'))">
      <div class="info-row">
        <div class="card-label">
            <div class="card-icon-box"><svg viewBox="0 0 24 24"><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></svg></div>
            <span data-zh="IPv6 地址" data-en="IPv6 Address">IPv6 Address</span>
        </div>
        <div id="ipv6" class="card-value skeleton"></div>
      </div>
    </div>

    <div class="card span-2" id="card_network">
      <div class="info-row">
        <div class="card-label">
            <div class="card-icon-box"><svg viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect><rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect><line x1="6" y1="6" x2="6.01" y2="6"></line><line x1="6" y1="18" x2="6.01" y2="18"></line></svg></div>
            <span data-zh="网络信息" data-en="Network Info">Network Info</span>
        </div>
        <div class="network-list">
            <div class="network-item" onclick="copyText(document.getElementById('hostname'))" style="cursor:pointer">
                <div class="network-label" data-zh="主机名" data-en="Hostname">Hostname</div>
                <div id="hostname" class="network-val skeleton"></div>
            </div>
            <div class="network-item" id="secondary-row" style="cursor:pointer; display:none;">
                <div class="network-label" id="sec-label">LAN IP</div>
                <div id="sec-val" class="network-val">...</div>
            </div>
        </div>
      </div>
    </div>

  

    <div class="card span-2" id="card_org" onclick="copyText(document.getElementById('org'))">
      <div class="info-row">
        <div class="card-label">
            <div class="card-icon-box"><svg viewBox="0 0 24 24"><path d="M3 21h18"></path><path d="M5 21V7l8-4 8 4v14"></path><path d="M17 21v-8H7v8"></path></svg></div>
            <span data-zh="运营商 / 组织" data-en="ISP / Organization">ISP / Organization</span>
        </div>
        <div id="org" class="card-value skeleton"></div>
      </div>
    </div>

    <div class="card span-1" id="card_country" onclick="copyText(document.getElementById('country'))">
      <div class="info-row">
        <div class="card-label">
            <div class="card-icon-box"><svg viewBox="0 0 24 24"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg></div>
            <span data-zh="国家" data-en="Country">Country</span>
        </div>
        <div id="country" class="card-value skeleton"></div>
      </div>
    </div>

    <div class="card span-1" id="card_continent" onclick="copyText(document.getElementById('continent'))">
      <div class="info-row">
        <div class="card-label">
            <div class="card-icon-box"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M2 12h20"></path><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg></div>
            <span data-zh="大洲" data-en="Continent">Continent</span>
        </div>
        <div id="continent" class="card-value skeleton"></div>
      </div>
    </div>

    <div class="card span-2" id="card_ua" onclick="copyText(document.getElementById('uaInfo'))">
      <div class="info-row">
        <div class="card-label">
            <div class="card-icon-box"><svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg></div>
            <span data-zh="设备信息" data-en="Device Info">Device Info</span>
        </div>
        <div id="uaInfo" class="card-value" style="font-size:0.85rem; line-height:1.5;">Detecting...</div>
      </div>
    </div>

    <div class="card span-1" id="card_asn" onclick="copyText(document.getElementById('asn'))">
      <div class="info-row">
        <div class="card-label">
            <div class="card-icon-box"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M16.24 7.76l-2.12 6.36-6.36 2.12 2.12-6.36 6.36-2.12z"></path></svg></div>
            <span data-zh="ASN" data-en="ASN">ASN</span>
        </div>
        <div id="asn" class="card-value skeleton"></div>
      </div>
    </div>

    <div class="card span-1" id="card_postal" onclick="copyText(document.getElementById('postal'))">
      <div class="info-row">
        <div class="card-label">
            <div class="card-icon-box"><svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></div>
            <span data-zh="邮编" data-en="Postal Code">Postal Code</span>
        </div>
        <div id="postal" class="card-value skeleton"></div>
      </div>
    </div>

    <div class="card span-2" id="card_connectivity" onclick="refreshLatency()">
      <div class="info-row" style="gap:12px;">
        <div class="card-label">
             <div class="card-icon-box"><svg viewBox="0 0 24 24"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></svg></div>
             <span data-zh="网络连通性" data-en="Connectivity">Connectivity</span>
        </div>
        <div class="latency-list">
            <div class="latency-item">
                <div class="latency-name"><div class="status-dot" id="dot-google"></div>Google</div>
                <div class="latency-ms" id="lat-google">-- ms</div>
            </div>
            <div class="latency-item">
                <div class="latency-name"><div class="status-dot" id="dot-github"></div>GitHub</div>
                <div class="latency-ms" id="lat-github">-- ms</div>
            </div>
            <div class="latency-item">
                <div class="latency-name"><div class="status-dot" id="dot-cf"></div>Cloudflare</div>
                <div class="latency-ms" id="lat-cf">-- ms</div>
            </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
const els={ipAddr:document.getElementById('ipAddr'),ipPlace:document.getElementById('ipPlace'),ipv6:document.getElementById('ipv6'),hostname:document.getElementById('hostname'),country:document.getElementById('country'),asn:document.getElementById('asn'),org:document.getElementById('org'),continent:document.getElementById('continent'),postal:document.getElementById('postal'),flag:document.getElementById('ip-flag'),flagSk:document.getElementById('flagSkeleton'),uaInfo:document.getElementById('uaInfo'),secLabel:document.getElementById('sec-label'),secVal:document.getElementById('sec-val'),secRow:document.getElementById('secondary-row'),
// New Map Elements
heroCard: document.getElementById('heroCard'),
heroMapFrame: document.getElementById('heroMapFrame')
};
let lastIpv6='';
let currentLang = 'en';
let mapUrl = ''; // Store the map URL

const langToggleBtn = document.getElementById('langToggle');
const themeToggleBtn = document.getElementById('themeToggle');
const themeIcon = themeToggleBtn.querySelector('svg');
const htmlEl = document.documentElement;
const systemDarkQuery = window.matchMedia('(prefers-color-scheme: dark)');

// Icons paths
const moonPath = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
const sunPath = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';

document.getElementById('refreshBtn').addEventListener('click', () => {
    localStorage.removeItem('ip_geo_cache');
    location.reload();
});

function switchLang(lang){
  currentLang = lang;
  langToggleBtn.textContent = lang === 'en' ? 'EN' : '中';
  document.querySelectorAll('[data-zh]').forEach(el=>{
    el.textContent = el.getAttribute(`data-${lang}`);
  });
  localStorage.setItem('lang', lang);
  
  updateCardVisibility('card_ipv6', els.ipv6.textContent);
  updateCardVisibility('card_country', els.country.textContent);
  updateCardVisibility('card_asn', els.asn.textContent);
  updateCardVisibility('card_continent', els.continent.textContent);
  updateCardVisibility('card_postal', els.postal.textContent);
  
  els.secLabel.textContent = lang === 'zh' ? '局域网 IP' : 'LAN IP';
}

langToggleBtn.addEventListener('click', () => {
    switchLang(currentLang === 'en' ? 'zh' : 'en');
});

function applyThemeUI(isDark) {
    if (isDark) {
        htmlEl.classList.add('dark-mode');
        themeIcon.innerHTML = sunPath;
    } else {
        htmlEl.classList.remove('dark-mode');
        themeIcon.innerHTML = moonPath;
    }
}

function initTheme() {
    applyThemeUI(systemDarkQuery.matches);
    systemDarkQuery.addEventListener('change', (e) => applyThemeUI(e.matches));
}

themeToggleBtn.addEventListener('click', () => {
    applyThemeUI(!htmlEl.classList.contains('dark-mode'));
});

// --- Connectivity ---
const sites = [{ id: 'google', url: 'https://www.google.com/favicon.ico' }, { id: 'github', url: 'https://github.com/favicon.ico' }, { id: 'cf', url: 'https://www.cloudflare.com/favicon.ico' }];
let latencyInterval;
async function checkLatency() {
    sites.forEach(async (site) => {
        const start = performance.now();
        const dot = document.getElementById(`dot-${site.id}`);
        const txt = document.getElementById(`lat-${site.id}`);
        txt.style.opacity = '0.5';
        try {
            await fetch(site.url, { mode: 'no-cors', cache: 'no-store' });
            const duration = Math.round(performance.now() - start);
            txt.textContent = `${duration} ms`;
            txt.style.opacity = '1';
            dot.classList.remove('pulse');
            if(duration < 200) { dot.style.background = 'var(--status-green)'; } 
            else if(duration < 500) { dot.style.background = 'var(--status-yellow)'; } 
            else { dot.style.background = 'var(--status-red)'; }
            void dot.offsetWidth; dot.classList.add('pulse');
        } catch (e) {
            txt.textContent = 'Error'; txt.style.opacity = '1'; dot.style.background = 'var(--status-red)';
        }
    });
}
function refreshLatency() {
    clearInterval(latencyInterval);
    sites.forEach(site => {
        document.getElementById(`lat-${site.id}`).textContent = '...';
        document.getElementById(`dot-${site.id}`).style.background = 'var(--status-gray)';
    });
    checkLatency();
    latencyInterval = setInterval(checkLatency, 3000);
}

// --- Browser Info ---
function getBrowserInfo() {
    const ua = navigator.userAgent;
    let browser = "Unknown";
    if(ua.includes("Edg")) browser = "Edge";
    else if(ua.includes("Chrome")) browser = "Chrome";
    else if(ua.includes("Firefox")) browser = "Firefox";
    else if(ua.includes("Safari")) browser = "Safari";
    let os = "Unknown OS";
    if (ua.indexOf("Win")!=-1) os="Windows";
    else if (ua.indexOf("Mac")!=-1) os="MacOS";
    else if (ua.indexOf("X11")!=-1) os="UNIX";
    else if (ua.indexOf("Linux")!=-1) os="Linux";
    else if (ua.indexOf("Android")!=-1) os="Android";
    else if (ua.indexOf("iPhone")!=-1) os="iOS";
    const screenRes = `${window.screen.width} x ${window.screen.height}`;
    els.uaInfo.innerHTML = `${browser} on ${os}<br><span style="color:var(--text-label);font-size:0.8em">Screen: ${screenRes}</span>`;
}

// --- Local IP (WebRTC) ---
async function getLocalIP() {
  return new Promise((resolve) => {
    try {
      const pc = new RTCPeerConnection({iceServers: []});
      pc.createDataChannel('');
      pc.createOffer().then(o => pc.setLocalDescription(o));
      pc.onicecandidate = (ice) => {
        if (ice && ice.candidate && ice.candidate.candidate) {
           const result = /([0-9]{1,3}(\.[0-9]{1,3}){3})/.exec(ice.candidate.candidate);
           if(result) { resolve(result[1]); pc.close(); }
        }
      };
      setTimeout(() => { resolve(null); if(pc) pc.close(); }, 1000);
    } catch(e) { resolve(null); }
  });
}

async function initNetworkCard() {
    const localIP = await getLocalIP();
    if(localIP) {
        els.secLabel.textContent = currentLang === 'zh' ? '局域网 IP' : 'LAN IP';
        els.secVal.textContent = localIP;
        els.secRow.style.display = 'flex'; 
        els.secRow.onclick = () => copyText(els.secVal);
    } else {
        els.secRow.style.display = 'none'; 
    }
}

async function copyText(el){
  const text = el.innerText.trim();
  if(text && text!=='Unknown'&&text!=='Not Detected'&&text!=='N/A'&&text!=='...'){
    try{ 
        await navigator.clipboard.writeText(text); 
        const originalColor = el.style.color;
        el.classList.add('copied');
        setTimeout(() => el.classList.remove('copied'), 600);
    } catch{}
  }
}
function rmSk(el){el.classList.remove('skeleton')}
function showFlag(){els.flagSk.style.display='none';els.flag.classList.add('loaded')}

const CACHE_KEY = 'ip_geo_cache';
const CACHE_TTL = 10 * 60 * 1000;

async function fetchT(url,t=6000){const c=new AbortController();setTimeout(()=>c.abort(),t);const r=await fetch(url,{signal:c.signal});if(!r.ok)throw'';const ct=r.headers.get('content-type')||'';return ct.includes('json')||ct.includes('text')?r.json():{text:(await r.text()).trim()}}

async function getIPs() {
  const [v4, v6] = await Promise.allSettled([
    fetchT('https://api.ipify.org?format=json'),
    fetchT('https://api64.ipify.org?format=json')
  ]);

  const ipv4 = v4.status === 'fulfilled' ? (v4.value.ip || v4.value.text || 'Unknown') : 'Unknown';
  const ipv6 = v6.status === 'fulfilled' ? (v6.value.ip || v6.value.text || '') : 'Not Detected';

  if (ipv6 && ipv6 !== ipv4) lastIpv6 = ipv6;

  return {
    ipv4: ipv4,
    ipv6: ipv6 || lastIpv6 || 'Not Detected'
  };
}

async function getGeo(ip){
  const cache = localStorage.getItem(CACHE_KEY);
  if(cache){
    const {data, timestamp, cachedIp} = JSON.parse(cache);
    if(cachedIp === ip && Date.now() - timestamp < CACHE_TTL){ return data; }
  }
  const apis=[`https://ipwho.is/${ip?encodeURIComponent(ip):''}`,`https://ipapi.co/${ip?encodeURIComponent(ip)+'/':''}json/`,'https://ipinfo.io/json'];
  for(const u of apis){
    try{
      const d=await fetchT(u);
      if(d&&(d.ip||d.query||d.loc)){
        localStorage.setItem(CACHE_KEY, JSON.stringify({data:d, timestamp:Date.now(), cachedIp:ip}));
        return d;
      }
    }catch{}
  }
  return null;
}

function renderCoords(lat, lon){
  // Update Global mapUrl
  mapUrl = currentLang === 'zh' 
    ? `https://uri.amap.com/marker?position=${lon},${lat}&name=Location` 
    : `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
  
  // 绑定整个卡片的点击事件
  els.heroCard.onclick = () => window.open(mapUrl, '_blank');

  // Set Iframe Src
  const nLat = parseFloat(lat);
  const nLon = parseFloat(lon);
  const delta = 0.05; 
  requestAnimationFrame(() => {
     els.heroMapFrame.src = `https://www.openstreetmap.org/export/embed.html?bbox=${nLon-delta},${nLat-delta},${nLon+delta},${nLat+delta}&layer=mapnik&marker=${nLat},${nLon}`;
     els.heroMapFrame.onload = () => { els.heroMapFrame.classList.add('loaded'); };
  });
}

function updateCardVisibility(id, value) {
    const el = document.getElementById(id);
    const shouldHide = !value || value === 'Unknown' || value === '未知' || value === 'Not Detected' || value === '未检测到';
    if (shouldHide) { el.style.display = 'none'; } else { el.style.display = 'flex'; }
}

function render(ip,geo){
  rmSk(els.ipAddr);
  if(!geo){rmSk(els.ipPlace);els.ipPlace.textContent=currentLang==='zh'?'未知地区':'Unknown Location';els.flagSk.style.display='none';return}
  const place=(geo.country_name||geo.country||'')+(geo.city?' · '+geo.city:'');
  els.ipPlace.innerHTML = place || (currentLang==='zh'?'未知地区':'Unknown Location'); rmSk(els.ipPlace);
  let code=(geo.country_code||geo.country||'').toLowerCase();
  if(code.length===2){els.flag.src=`https://flagcdn.com/w160/${code}.png`;els.flag.onload=showFlag;if(els.flag.complete&&els.flag.naturalWidth)showFlag()}else{els.flagSk.style.display='none'}
  [els.hostname,els.country,els.asn,els.org,els.continent,els.postal,els.ipv6].forEach(rmSk);
  
  const v6 = geo.ipv6||lastIpv6;
  if(v6 && v6!=='Not Detected') { els.ipv6.textContent=v6; } else { els.ipv6.textContent=currentLang==='zh'?'未检测到':'Not Detected'; }
  updateCardVisibility('card_ipv6', els.ipv6.textContent);

  els.country.textContent=geo.country_name||geo.country|| (currentLang==='zh'?'未知':'Unknown');
  updateCardVisibility('card_country', els.country.textContent);

  const asnNum=geo.connection?.asn||geo.asn||'';
  els.asn.textContent=asnNum?(currentLang==='zh'?`AS${asnNum}`:`AS${asnNum}`): (currentLang==='zh'?'未知':'Unknown');
  updateCardVisibility('card_asn', els.asn.textContent);

  els.continent.textContent=geo.continent_name||geo.continent|| (currentLang==='zh'?'未知':'Unknown');
  updateCardVisibility('card_continent', els.continent.textContent);

  els.postal.textContent=geo.postal||geo.postal_code|| (currentLang==='zh'?'未知':'Unknown');
  updateCardVisibility('card_postal', els.postal.textContent);

  els.org.textContent=geo.org||geo.connection?.isp||geo.isp|| (currentLang==='zh'?'未知':'Unknown');

  const lat=geo.latitude||geo.lat,lon=geo.longitude||geo.lon;
  if(lat && lon && !isNaN(lat) && !isNaN(lon)){ renderCoords(lat, lon); }

  fetchHostname(geo.ip||geo.query||'').then(h=>els.hostname.textContent=h|| (currentLang==='zh'?'未检测到':'Not Detected'));
}

async function fetchHostname(ip){if(!ip)return currentLang==='zh'?'未检测到':'Not Detected';try{const r=await fetch(`https://dns.google/resolve?name=${ip.split('.').reverse().join('.')}.in-addr.arpa&type=PTR`);const d=await r.json();return d.Answer?.[0]?.data?.replace(/\.$/,'')|| (currentLang==='zh'?'未检测到':'Not Detected')}catch{return currentLang==='zh'?'未检测到':'Not Detected'}}

async function start(){
  localStorage.removeItem('theme');
  initTheme();
  getBrowserInfo();
  checkLatency(); 
  latencyInterval = setInterval(checkLatency, 3000);
  initNetworkCard();

  const savedLang = localStorage.getItem('lang');
  if (savedLang) { switchLang(savedLang); } else { switchLang('en'); }
  const {ipv4,ipv6}=await getIPs();
  const primary=ipv4!=='Unknown'?ipv4:(ipv6.includes('Not Detected')?'Unknown':ipv6);
  els.ipAddr.textContent=primary;rmSk(els.ipAddr);els.ipv6.textContent=ipv6;
  if(primary==='Unknown'){els.flagSk.style.display='none';return}
  const geo=await getGeo(primary);
  render(primary,geo);
}
window.onload=()=>start();
</script>
</body>
</html>