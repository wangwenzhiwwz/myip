<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IP 地址查询工具</title>
<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="apple-touch-icon" sizes="180x180" href="https://wangwenzhi.eu.org/images/favicon_io/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="https://wangwenzhi.eu.org/images/favicon_io/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="https://wangwenzhi.eu.org/images/favicon_io/favicon-16x16.png">
	<link rel="manifest" href="https://wangwenzhi.eu.org/images/favicon_io/site.webmanifest">
<style>
/* -------- 基础与排版 -------- */
html,body{height:100%;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:#fff;color:#111;}
body{min-height:100vh;width:100vw;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;}

/* 主标题区 – 15% 顶部留白 */
.main-top{width:100%;max-width:680px;margin:0 auto;display:flex;flex-direction:column;align-items:center;padding-top:0;gap:1.5rem;margin-top:15vh;}
/* IP 主卡片 */
.ip-main-card{width:100%;display:flex;flex-direction:row;align-items:center;gap:1rem;justify-content:center;}
.flag-img{width:60px;height:40px;border-radius:8px;background:#fff;display:none;object-fit:cover;box-shadow:0 1px 8px #eee;}
.ip-main-info{display:flex;flex-direction:column;align-items:center;gap:.5rem;}
.ip-big-value{font-size:3.2rem;font-weight:700;color:#111;word-break:break-all;line-height:1.2;text-align:center;}
.ip-place{font-size:1.3rem;color:#333;line-height:1.5;min-height:1.5em;text-align:center;}
/* 详细信息卡片 */
.detail-card{width:100%;background:#fafafa;border-radius:16px;padding:1.6rem 1.4rem 1.4rem 1.4rem;display:flex;flex-direction:column;gap:0.8rem;}
.detail-title{font-size:1.3rem;font-weight:700;color:#444;padding-bottom:.4rem;margin-bottom:.6rem;border-bottom:1px solid #eee;letter-spacing:1px;}
.detail-row{width:100%;display:grid;grid-template-columns:1fr;gap:0.5rem;}
.detail-cell{display:grid;grid-template-columns:1fr 2fr;gap:.2rem;align-items:center;min-width:0;padding:.3rem 0;border-bottom:1px solid #f0f0f0;}
.detail-label{font-size:1.05rem;color:#888;font-weight:500;letter-spacing:.5px;}
.detail-value{font-size:1.05rem;color:#111;word-break:break-all;}
.ipv6-value{color:#111;}
/* 操作行 */
.op-row{width:100%;display:flex;gap:.8rem;margin-top:.4rem;}
.ip-input-slim{flex:1;font-size:1.1rem;padding:.8rem 1rem;border:1px solid #e0e1e6;border-radius:10px;background:#fff;color:#111;outline:none;box-sizing:border-box;transition:border-color .19s;}
.ip-input-slim:focus{border-color:#111;box-shadow:0 0 0 1px #1112;}
.btn-slim{padding:.8rem 0;background:#111;color:#fff;border:none;border-radius:10px;font-weight:700;font-size:1.1rem;cursor:pointer;min-width:90px;transition:background .19s;display:flex;align-items:center;justify-content:center;gap:.2rem;}
.btn-slim:active,.btn-slim:focus{background:#000;}
.btn-slim:disabled{background:#e7e7e7;color:#aaa;cursor:not-allowed;}
.btn-refresh{background:#fff;color:#111;border:1px solid #eee;}
.btn-refresh:active,.btn-refresh:focus{background:#f3f3f3;color:#000;}
.status-text{width:100%;text-align:center;font-size:1.05rem;color:#aaa;min-height:1.7em;margin-top:1rem;letter-spacing:.1px;}
.status-text.ok{color:#111;}
.status-text.err{color:#e00;}
.status-text.loading{color:#111;}

/* 移动端微调 */
@media (max-width:680px){
  .main-top{max-width:95vw;margin-top:15vh auto 0;}
  .ip-main-card,.detail-card,.op-row{align-items:center;}
  .ip-main-info,.detail-card{align-items:center;}
  .detail-row{gap:.4rem;}
  .detail-card{gap:.6rem;}
  .detail-cell{padding:.25rem 0;}
  .status-text{text-align:center;}
  .ip-big-value{font-size:2.4rem;}
  .flag-img{width:48px;height:32px;}
  .detail-title{font-size:1.2rem;}
  .detail-label{font-size:.95rem;}
  .detail-value{font-size:.95rem;}
  .ip-input-slim,.btn-slim{font-size:1rem;}
}
</style>
</head>
<body>
<div class="main-top">
  <div class="ip-main-card">
    <img id="ip-flag" class="flag-img" alt="国旗" />
    <div class="ip-main-info">
      <div id="ipAddr" class="ip-big-value"></div>
      <div id="ipPlace" class="ip-place"></div>
    </div>
  </div>
  <div class="detail-card">
    <div class="detail-title">详细网络信息</div>
    <div class="detail-row">
      <!-- IPv6 -->
      <div class="detail-cell"><div class="detail-label">IPv6 地址</div><div id="ipv6" class="detail-value ipv6-value"></div></div>
      <!-- 主机名 -->
      <div class="detail-cell"><div class="detail-label">主机名</div><div id="hostname" class="detail-value"></div></div>
      <!-- ASN -->
      <div class="detail-cell"><div class="detail-label">自治系统（ASN）</div><div id="asn" class="detail-value"></div></div>
      <!-- ISP/运营商 -->
      <div class="detail-cell"><div class="detail-label">运营商/组织</div><div id="org" class="detail-value"></div></div>
      <!-- 大洲 -->
      <div class="detail-cell"><div class="detail-label">大洲</div><div id="continent" class="detail-value"></div></div>
      <!-- 纬度 -->
      <div class="detail-cell"><div class="detail-label">纬度</div><div id="lat" class="detail-value"></div></div>
      <!-- 经度 -->
      <div class="detail-cell"><div class="detail-label">经度</div><div id="lon" class="detail-value"></div></div>
      <!-- 邮编 -->
      <div class="detail-cell"><div class="detail-label">邮编</div><div id="postal" class="detail-value"></div></div>
    </div>
  </div>
  <div class="op-row">
    <input id="manualIp" class="ip-input-slim" type="text" placeholder="输入IP地址查询（留空查本机）">
    <button id="btnQuery" class="btn-slim"><i class="fa fa-search" aria-hidden="true"></i> 查询</button>
    <button id="btnRefresh" class="btn-slim btn-refresh"><i class="fa fa-refresh" aria-hidden="true"></i> 刷新</button>
  </div>
  <div id="status" class="status-text loading"></div>
</div>
<script>
const TIMEOUT=8000;
const ipAddrEl=document.getElementById('ipAddr');
const ipPlaceEl=document.getElementById('ipPlace');
const ipv6El=document.getElementById('ipv6');
const hostnameEl=document.getElementById('hostname');
const asnEl=document.getElementById('asn');
const orgEl=document.getElementById('org');
const continentEl=document.getElementById('continent');
const latEl=document.getElementById('lat');
const lonEl=document.getElementById('lon');
const postalEl=document.getElementById('postal');
const statusEl=document.getElementById('status');
const flagEl=document.getElementById('ip-flag');
const manualIpInput=document.getElementById('manualIp');
const btnQuery=document.getElementById('btnQuery');
const btnRefresh=document.getElementById('btnRefresh');
let lastIpv6='';

// 通用 fetch，支持超时
async function fetchWithTimeout(url, timeout=TIMEOUT){
  const controller=new AbortController();
  const id=setTimeout(()=>controller.abort(), timeout);
  try{
    const rs=await fetch(url,{signal:controller.signal});
    if(!rs.ok) throw new Error(`HTTP 错误: ${rs.status}`);
    const ct=rs.headers.get('content-type')||'';
    if(ct.includes('application/json')||ct.includes('text/plain')) return await rs.json();
    return {text:await rs.text()};
  }finally{
    clearTimeout(id);
  }
}

// 反向 DNS (PTR) 查询
async function fetchHostname(ip){
  if(!ip) return '未检测到';
  const rev = ip.split('.').reverse().join('.') + '.in-addr.arpa';
  try{
    const r = await fetch(`https://dns.google/resolve?name=${rev}&type=PTR`);
    const data = await r.json();
    const host = data?.Answer?.[0]?.data?.replace(/\.$/, '');
    return host || '未检测到';
  }catch(_){
    return '未检测到';
  }
}

// 主体逻辑：查询地理信息
async function fetchGeoInfo(ip=''){
  updateStatus('正在查询地理信息…','loading');
  try{
    const url = ip ? `https://ipwho.is/${encodeURIComponent(ip)}` : 'https://ipwho.is/?format=json';
    const data = await fetchWithTimeout(url);
    if(data && (data.success===true||data.success===undefined)){
      renderGeo(data);
      updateStatus('', 'ok');
      return;
    }
    throw new Error('ipwho.is 返回无效');
  }catch(e){}
  try{
    const url = ip ? `https://ipapi.co/${encodeURIComponent(ip)}/json/` : 'https://ipapi.co/json/';
    const data = await fetchWithTimeout(url);
    renderGeo(data);
    updateStatus('', 'ok');
  }catch(e){
    updateStatus('地理信息查询失败，请稍后重试', 'err');
    resetLoading(false);
  }
}

// 解析并渲染 Geo 数据
function renderGeo(data){
  // 国旗
  let code='';
  if(data.country_code && /^[A-Za-z]{2}$/.test(data.country_code)) code=data.country_code.toLowerCase();
  else if(data.country && /^[A-Za-z]{2}$/.test(data.country)) code=data.country.toLowerCase();
  if(code){
    flagEl.src=`https://cdn.jsdelivr.net/npm/flag-icon-css@4.1.7/flags/4x3/${code}.svg`;
    flagEl.style.display='block';
  }else flagEl.style.display='none';

  // IP & 地区
  const ipVal = data.ip||data.query||data.address||'未知IP';
  ipAddrEl.textContent=ipVal;
  const place = (data.country_name||data.country||'') 
                + (data.city?' '+data.city:'' )
                + (data.region_name||data.region?' · '+(data.region_name||data.region):'');
  ipPlaceEl.textContent=place;

  // IPv6
  if(data.ipv6||(data.connection&&data.connection.ipv6)){
    lastIpv6=data.ipv6||data.connection.ipv6;
    ipv6El.textContent=lastIpv6;
  }else ipv6El.textContent=lastIpv6?lastIpv6:'未检测到';

  // 主机名（反向 DNS）
  hostnameEl.textContent='';
  fetchHostname(data.ip||data.query||'').then(host=>{ hostnameEl.textContent=host; });

  // ASN
  asnEl.textContent=(data.connection?.asn)||data.asn||'未知';

  // ISP/运营商
  orgEl.textContent=data.org||data.connection?.isp||data.isp||'未知';

  // 大洲
  continentEl.textContent=data.continent_name||data.continent||'未知';

  // 纬度
  latEl.textContent=data.latitude||'未知';

  // 经度
  lonEl.textContent=data.longitude||'未知';

  // 邮编
  postalEl.textContent=data.postal||data.postal_code||'未知';
}

// 本机 IP 检测
async function getLocalIP(){
  resetLoading(true);
  updateStatus('正在获取本机 IP 地址…','loading');
  let ip='',ipv6='';
  try{
    const r=await fetchWithTimeout('https://api.ipify.org?format=json');
    ip=r.ip||r.text||'';
    ipAddrEl.textContent=ip;
  }catch(e){
    ipAddrEl.textContent='无法获取 IPv4 地址';
  }
  try{
    const r=await fetchWithTimeout('https://api64.ipify.org?format=json');
    ipv6=r.ip||r.text||'';
    if(ipv6&&ipv6!==ip){
      lastIpv6=ipv6;
      ipv6El.textContent=ipv6;
    }else ipv6El.textContent='未检测到';
  }catch(e){
    ipv6El.textContent=lastIpv6?lastIpv6:'未检测到';
  }
  if(ip&& !ip.startsWith('无法')) await fetchGeoInfo(ip);
  else if(lastIpv6&& !lastIpv6.startsWith('未检测')) await fetchGeoInfo(lastIpv6);
  else{
    updateStatus('未检测到可用公网 IP，无法查询地理信息', 'err');
    resetLoading(false);
  }
}

// 手动查询
async function handleManualQuery(){
  const target=manualIpInput.value.trim();
  if(!target){
    updateStatus('请输入 IP 地址，留空查本机','default');
    return;
  }
  setBtnDisabled(true);
  resetLoading(true);
  updateStatus(`正在查询 IP: ${target} 的信息…','loading`);
  try{
    ipAddrEl.textContent=target;
    ipPlaceEl.textContent='';
    await fetchGeoInfo(target);
  }finally{
    setBtnDisabled(false);
  }
}

// UI 辅助函数
function updateStatus(msg,type='default'){
  statusEl.textContent=msg;
  statusEl.className=`status-text ${type}`;
}
function resetLoading(isLoading){
  // 只清空文本内容，不再显示动画
  const elList=[ipAddrEl,ipPlaceEl,ipv6El,hostnameEl,asnEl,orgEl,continentEl,latEl,lonEl,postalEl];
  elList.forEach(el=>{el.textContent='';});
}
function setBtnDisabled(dis){
  btnQuery.disabled=btnRefresh.disabled=dis;
  btnQuery.innerHTML=dis?
    `<i class="fa fa-spinner fa-spin" aria-hidden="true"></i> 查询中`:
    `<i class="fa fa-search" aria-hidden="true"></i> 查询`;
  btnRefresh.innerHTML=dis?
    `<i class="fa fa-spinner fa-spin" aria-hidden="true"></i> 刷新中`:
    `<i class="fa fa-refresh" aria-hidden="true"></i> 刷新`;
}

// 事件绑定
btnQuery.addEventListener('click',handleManualQuery);
btnRefresh.addEventListener('click',async()=>{
  setBtnDisabled(true);
  await getLocalIP();
  setBtnDisabled(false);
});
window.addEventListener('DOMContentLoaded',getLocalIP);
</script>
</body>
</html>
